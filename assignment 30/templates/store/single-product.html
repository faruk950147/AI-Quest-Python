{% extends 'base.html' %}
{% load static %}
{% block title %}Product Detail{% endblock title %}

{% block main_content %}
<div class="container my-5">
    <div class="row">
        <!-- Product Image -->
        <div class="col-sm-6 text-center align-self-center">
            <div class="card shadow-sm border-0 p-3" 
                 style="max-width: 400px; max-height: 400px; overflow: hidden; 
                        display: flex; align-items: center; justify-content: center;">
                <img src="{{ product.image.url }}" 
                     alt="{{ product.title|title }}" 
                     class="img-fluid" 
                     style="width: 100%; height: 100%; object-fit: contain;">
            </div>
        </div>

        <!-- Product Details -->
        <div class="col-sm-5 offset-sm-1">
            <h2>Product Title: {{ product.title|title }}</h2>
            <hr>
            <p>{{ product.description }}</p>
            <br>
            <h4>
                Tk. {{ product.sale_price }}
                <small class="fw-light text-decoration-line-through">
                    {% if product.old_price %}
                        {{ product.old_price }}
                    {% endif %}
                </small>
            </h4>
            <br>
            <p>Available Discount: {{ product.discount_percent|title }}%</p>

            <div class="card-body">
                <!-- Add To Cart Form -->
                <form method="POST" action="{% url 'add-to-cart' %}" class="m-0" id="form">
                    {% csrf_token %}
                    <p class="text-muted mb-3 text-start">Select Quantity</p>

                    <!-- Quantity Input -->
                    <div class="mb-3" style="max-width: 120px;">
                        <input type="number" 
                               name="quantity"
                               id="quantity"  
                               class="form-control text-center" 
                               value="1" 
                               min="1" 
                               max="{{ product.available_stock }}" 
                               required>
                        <input type="hidden" name="product-id" value="{{ product.id }}">
                    </div>

                    <!-- Buttons -->
                    <button type="submit" class="btn btn-success fw-semibold shadow-sm">
                        <i class="bi bi-cart-plus me-1"></i> Add To Cart
                    </button>

                    <a href="#" class="btn btn-danger fw-semibold shadow-sm">
                        <i class="bi bi-lightning-charge me-1"></i> Buy Now
                    </a>
                </form>
            </div>

            <!-- Additional Info -->
            <h5 class="mt-5">Available Info</h5>
            <ul>
                <li>Category: {{ product.category.title|title }}</li>
                <li>Brand: {{ product.brand.title|title }}</li>
                <li>Available stock: {{ product.available_stock }}</li>
                <li>Tag: {{ product.keyword|title }}</li>
            </ul>
        </div>
    </div>
</div>
{% endblock main_content %}
{% block extra_scripts %}
<script>
$(document).ready(function() {
    $("#form").on("submit", function(e) {
        e.preventDefault(); // Stop normal submission

        let formData = new FormData(this);  // Create FormData object

        $.ajax({
            url: "{% url 'add-to-cart' %}",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                "X-CSRFToken": formData.get("csrfmiddlewaretoken")
            },
            success: function(data) {
                if(data.status === "success") {
                    alert(data.message);
                    console.log(data)
                    // Update cart totals dynamically (if elements exist)
                    if($("#cart-total-items").length)
                        $("#cart-count").text(data.cart_count);

                    if($("#cart-total-price").length)
                        $("#cart-total-price").text(parseFloat(data.cart_total_price).toFixed(2));

                    // Reset quantity input
                    $("#quantity").val(1);
                } else {
                    alert(data.message);
                }
            },
            error: function(xhr, status, error) {
                console.error("AJAX Error:", error);
                alert("Something went wrong. Please try again.");
            }
        });
    });
});
</script>
{% endblock extra_scripts %}
